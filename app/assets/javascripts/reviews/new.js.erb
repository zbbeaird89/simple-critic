$(document).on('turbolinks:load', function() {

  // Star rating responses to both hover and click events
  $('.rating-form img').on({
    click:      function() { turnOnStars($(this), "click"); },
    mouseenter: function() { turnOnStars($(this), "mouseenter"); },
    mouseleave: function() { restoreStarsState($(this)); }
  });



  function turnOnStars(rootStar, ev) {
    starIndex = rootStar.parent().children().index(rootStar);

    turnOffTrailingStars(rootStar, starIndex, ev)

    for (var i = starIndex; i >= 0; i--) {
      var $star = findStar(rootStar, i);

      if (ev === "click") {
        $star.attr('data-state', "on")
      }

      $star.attr('src', '<%= image_path "star-on" %>');
    }

    if (ev === "click") {
      setInputValue(rootStar, (starIndex + 1))
    }
  } // turnOnStars



  function turnOffTrailingStars(rootStar, starIndex, ev) {
    starsLength = 5

    if (starIndex < (starsLength - 1)) {
      for (var i = starIndex; i < (starsLength -1); i++) {
        var $star = findStar(rootStar, (i + 1));

        if (ev === "click") {
          $star.attr('data-state', "off")
        }

        $star.attr('src', '<%= image_path "star-off" %>');
      }
    }
  } // turnOffTrailingStars



  function findStar(rootStar, i) {
    return rootStar.parent().children().eq(i);
  } // findStar



  function restoreStarsState(rootStar) {
    rootStar.parent().children().each(function(i, star) {
      if ($(star).attr('data-state') === 'on') {
        $(star).attr('src', '<%= image_path "star-on" %>');
      } else {
        $(star).attr('src', '<%= image_path "star-off" %>')
      }
    });
  } // restoreStarsState



  function setInputValue(star, value) {
    $ratingName = star.parent().parent().parent().attr('class');
    $('#new_review #review_' + $ratingName + '_rating').val(value);
  }
});
